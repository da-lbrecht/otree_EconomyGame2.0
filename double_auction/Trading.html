{% extends "global/Page.html" %} {% load otree %} {{ block title }} Double
Auction Market {{ endblock }} {{ block content }}

<div
  id="app"
  class="row grid h-100vh"
  style="grid-template-rows: min-content 1fr min-content"
>
  <header class="bg-um-blue text-white pb-1">
    <div class="row">
      <div class="col">
        <h1 class="fw-light">
          {{ if player.is_buyer }}Buyer{{ else }}Seller{{ endif }}
        </h1>
      </div>
      <div class="col-auto">
        <p id="market_closing_time" class="text-end opacity-50">
          Market closing time<br />{{ market_closing }}
        </p>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <p class="fw-bolder">Profit</p>
      </div>
      <div class="col text-end">
        <p>[[ data.balance || 0 ]] points</p>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <p class="fw-bolder">Tax</p>
      </div>
      <div class="col text-end">
        <p>-</p>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <p class="fw-bolder">Price ceiling (Pc)</p>
      </div>
      <div class="col text-end">
        <p>{{ price_ceiling }}</p>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <p class="fw-bolder">Price floor (Pf)</p>
      </div>
      <div class="col text-end">
        <p>{{ price_floor }}</p>
      </div>
    </div>
  </header>

  <main class="bg-white">
    <div class="row pt-2 pb-1">
      <div class="col text-end">
        <p class="fw-bold">Asks (in points)</p>
        <ul class="list-unstyled">
          <li v-for="(ask, index) in lowestAsks" :key="index">[[ ask ]]</li>
        </ul>
      </div>
      <div class="col text-end">
        <p class="fw-bold">Bids (in points)</p>
        <ul class="list-unstyled">
          <li v-for="(bid, index) in highestBids" :key="index">[[ bid ]]</li>
        </ul>
      </div>
    </div>

    <nav class="row">
      <div class="col">
        <ul class="nav pt-2">
          <li class="nav-item me-2 active">Open orders</li>
          <li class="nav-item">History</li>
        </ul>
      </div>
    </nav>
    <ul class="list-unstyled">
      <li v-for="(order, index) in openOrders" :key="index">
        <div class="row">
          <div class="col">[[ order.offer ]]</div>
          <div class="col">[[ order.time ]]</div>
        </div>
      </li>
    </ul>
  </main>

  <footer class="bg-um-blue text-white pt-1 pb-2">
    <div class="row">
      <div class="col-auto d-flex">
        <p class="fw-bolder me-1">
          Marginal {{ if player.is_buyer }}Unit (MC){{ else }}Cost (MC){{ endif
          }}
        </p>
        <div
          class="d-flex"
          data-bs-toggle="tooltip"
          data-bs-placement="top"
          title="You want to {{ if player.is_buyer }}buy lower{{ else }}sell higher{{ endif }} than
          this number"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            fill="currentColor"
            class="bi bi-info-circle-fill"
            viewBox="0 0 16 16"
          >
            <path
              d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"
            />
          </svg>
        </div>
      </div>
      <div class="col text-end">[[ data.marginal_evaluation ]] points</div>
    </div>
    <div class="row">
      <div class="col-auto">
        <p class="fw-bolder">
          {{ if player.is_buyer }}Consumption{{ else }}Production{{ endif }}
          time
        </p>
      </div>
      <div class="col text-end">
        <p>0 seconds</p>
      </div>
    </div>

    <div class="row">
      <div class="col d-flex justify-content-end">
        <div class="input-group mt-2">
          <input
            type="text"
            class="form-control text-end"
            placeholder="Offer (in points)"
            aria-label="Offer in points"
            aria-describedby="button-offer"
            v-model="offer"
            @keydown.enter.prevent="sendOffer"
          />
          <button
            class="btn btn-um-orange fw-bold"
            type="button"
            id="button-offer"
            @click="sendOffer"
          >
            {{ if player.is_buyer }}BID{{ else }}ASK{{ endif }}
          </button>
        </div>
      </div>
    </div>
  </footer>
</div>

<div>
    {{ if player.is_buyer }}
        {{ include 'double_auction/mu_chart.html' }}
    {{ else }}
        {{ include 'double_auction/mc_chart.html' }}
    {{ endif }}
</div>

{{ endblock }} {{ block scripts }}

<script src="https://unpkg.com/vue@3"></script>
<script>
  let app = Vue.createApp({
    data() {
      return {
        data: {},
        offer: null,
      };
    },

    mounted() {
      liveSocket.onmessage = function (e) {
        // console.log(JSON.parse(e.data));
        this.data = JSON.parse(e.data);
      }.bind(this);
    },

    computed: {
      lowestAsks() {
        return this.data.asks?.sort((a, b) => b - a).slice(-3);
      },
      highestBids() {
        return this.data.bids?.sort((a, b) => b - a).slice(0, 3);
      },
      openOrders() {
        const openOrders = [];

        for (let index = 0; index < this.data.offers?.length; index++) {
          openOrders.push({ offer: this.data.offers[index], time: this.data.offer_times[index] })
        }

        openOrders.sort(function(a, b) {
          return Date.parse(b.time) - Date.parse(a.time)
        })

        return openOrders;
      }
    },

    methods: {
      sendOffer() {
        if (!this.offer) return
        liveSend({ type: "offer", offer: this.offer });
        this.offer = null;
      }
    },
  });
  app.config.compilerOptions.delimiters = ["[[", "]]"];
  app.mount("#app");

  document.addEventListener("DOMContentLoaded", (event) => {
    liveSend({});
  });
</script>

{{ endblock scripts }}
