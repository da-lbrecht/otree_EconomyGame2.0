{{ block title }}
Trade
{{ endblock }}
{{ block content }}

<p id="news" style="color: green"></p>

<!-- Display of countdown till market closing -->
<p>The market closes in <span id="time-left"></span> </p>

<script>
    let customTimerEle = document.getElementById('time-left');

    document.addEventListener("DOMContentLoaded", function (event) {
        $('.otree-timer__time-left').on('update.countdown', function (event) {
            customTimerEle.innerText = event.strftime('%W weeks %-d days %-H h %M min %S sec');
            liveSend({"type": "time_update"})
        });
    });

</script>

<p id="market_closing_time"> Market opening time {{ market_opening }} </p>

<p id="market_closing_time"> Market closing time {{ market_closing }} </p>

<table class="table">
    <tr>
        <td>Your role</td>
        <th>
            {{ if player.is_buyer }}buyer{{ else }}seller{{ endif }}
        </th>
    </tr>
    <tr>
        <td>
            {{ if player.is_buyer }}
                Your current marginal utility (you should buy for less)
            {{ else }}
                Your current marginal costs (you should sell for more)
            {{ endif }}
        </td>
            <th id="marginal_evaluation"></th>
    </tr>
    <tr>
        <td>
            {{ if player.is_buyer }}
                Your current remaining consumption time (to enjoy your purchases)
            {{ else }}
                Your current remaining production time (to fulfill your order book)
            {{ endif }}
        </td>
            <th id="time_needed"></th>
    </tr>

    <tr>
        <td>{{ if player.is_buyer }}Your highest bid{{ else }}Your lowest ask{{ endif }}</td>
        <th id="current_offer"></th>
    </tr>
    <tr>
        <td>{{ if player.is_buyer }}All your bids (from high to low){{ else }}All your asks (from low to high){{ endif }}</td>
        <th id="offers"></th>
    </tr>

    <tr>
        <td>Your Balance</td>
        <th id="balance"></th>
    </tr>
</table>


<input type="number" id="my_offer">
<button type="button" onclick="sendOffer()" id="btn-offer">
    {{ if player.is_buyer }}Place bid{{ else }}Place ask{{ endif }}
</button>
<br><br>

<input type="number" id="my_withdrawal">
<button type="button" onclick="withdrawOffer()" id="btn-withdrawal">
    {{ if player.is_buyer }}Withdraw bid{{ else }}Withdraw ask{{ endif }}
</button>
<br><br>

<div class="container">
    <div class="row">
        <div class="col-sm">
            <h4>Bids (in points)</h4>
            <table id="bids_table"></table>
        </div>
        <div class="col-sm">
            <h4>Asks (in points)</h4>
            <table id="asks_table"></table>
        </div>
    </div>
</div>

<br><br>
{{ include 'double_auction/chart.html' }}


<script>

    let my_time_needed = document.getElementById('time_needed');
    let my_marginal_evaluation = document.getElementById('marginal_evaluation');
    let my_balance = document.getElementById('balance');
    let bids_table = document.getElementById('bids_table');
    let asks_table = document.getElementById('asks_table');
    let my_id = js_vars.id_in_group;
    let news_div = document.getElementById('news');
    let is_buyer = js_vars.is_buyer;
    let btnOffer = document.getElementById('btn-offer');
    let my_offer = document.getElementById('my_offer');
    let my_withdrawal = document.getElementById('my_withdrawal');

    function showNews(msg) {
        news_div.innerText = msg;
        setTimeout(function () {
            news_div.innerText = ''
        }, 10000)
    }

    function cu(amount) {
        return `${amount} points`;
    }

    function sec(amount) {
        return `${amount} seconds`;
    }

    function liveRecv(data) {
        console.log(data)
        // javascript destructuring assignment
        let {bids, asks, highcharts_series, current_offer, balance, news, offers, time_needed, marginal_evaluation} = data;
        if (news) {
            let {buyer, seller, price} = news;
            if (buyer === my_id) {
                showNews(`You bought from player ${seller} for ${cu(price)}`);
            } else if (seller === my_id) {
                showNews(`You sold to player ${buyer} for ${cu(price)}`);
            }
        }

        if (data["offers"] == "") {
            document.getElementById('current_offer').innerText = "";
            document.getElementById('offers').innerText = "";
        }
        else {
            document.getElementById('current_offer').innerText = cu(current_offer);
            document.getElementById('offers').innerText = cu(offers);
        }
        document.getElementById('balance').innerText = cu(balance);
{#        if (!is_buyer && num_items === 0) {
            btnOffer.disabled = true;
        }#}
        my_time_needed.innerHTML = sec(time_needed);
        my_marginal_evaluation.innerHTML = cu(marginal_evaluation);
        bids_table.innerHTML = bids;
        asks_table.innerHTML = asks;
        redrawChart(highcharts_series);

    }

    function sendOffer() {
        liveSend({"type": "offer", "offer": my_offer.value})
    }

    function withdrawOffer() {
        liveSend({"type": "withdrawal", "withdrawal": my_withdrawal.value})
    }

    my_offer.addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
            sendOffer();
        }
    });

    my_withdrawal.addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
            withdrawOffer();
        }
    });

    document.addEventListener('DOMContentLoaded', (event) => {
        liveSend({})
    });
</script>

{{ endblock }}
